#include <Wire.h>
#include <U8g2lib.h>

// Pin Definitions
#define BUTTON_CW    12    
#define BUTTON_CCW   13    
#define BUTTON_STOP  14    
#define BUTTON_PRINT 15    
#define FSR_PIN      36    
#define ENA          5     
#define IN1          4     
#define IN2          2     
#define LED1         32    
#define LED2         33    
#define LED3         34    
#define SDA_PIN      21    
#define SCL_PIN      22    
#define PROXIMITY_PIN 26    
#define PRINTER_TX 17  
#define PRINTER_RX 16

HardwareSerial printerSerial(1);
U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, U8X8_PIN_NONE, SCL_PIN, SDA_PIN);

float forceValue = 0, maxForce = 0, breakExtension = 0;
bool isTesting = false;
unsigned long startTime;
float smoothedForce = 0;
const float alpha = 0.1;
unsigned long lastButtonPressTime = 0;
const unsigned long debounceDelay = 50;

void setup() {
  Serial.begin(115200);
  printerSerial.begin(9600, SERIAL_8N1, PRINTER_RX, PRINTER_TX);

  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(ENA, OUTPUT);
  pinMode(BUTTON_CW, INPUT_PULLUP);
  pinMode(BUTTON_CCW, INPUT_PULLUP);
  pinMode(BUTTON_STOP, INPUT_PULLUP);
  pinMode(BUTTON_PRINT, INPUT_PULLUP);
  pinMode(LED1, OUTPUT);
  pinMode(PROXIMITY_PIN, INPUT);

  Wire.begin(SDA_PIN, SCL_PIN);
  Wire.setClock(400000);
  u8g2.begin();
  u8g2.setFont(u8g2_font_ncenB08_tr);
  u8g2.clearBuffer();
  u8g2.sendBuffer();
}

void loop() {
  int rawForce = analogRead(FSR_PIN);
  float currentForce = map(rawForce, 4095, 0, 0, 1000) / 100.0; 
  currentForce = constrain(currentForce, 0, 10);
  smoothedForce = (alpha * currentForce) + ((1 - alpha) * smoothedForce);
  forceValue = smoothedForce;

  if (isTesting && forceValue > maxForce) maxForce = forceValue;

  if (debounceButton(BUTTON_CW) && !isTesting) startTest();
  if (debounceButton(BUTTON_CCW)) moveCounterClockwise();
  if (debounceButton(BUTTON_STOP)) stopMotor();
  if (debounceButton(BUTTON_PRINT)) printReport();

  int proximityValue = analogRead(PROXIMITY_PIN);
  float distance = map(proximityValue, 0, 4095, 0, 100);
  if (distance <= 10) {
    stopMotor();
    Serial.println("Motor Stopped - Block too close");
  }

  if (isTesting && forceValue < (maxForce * 0.2)) {
    breakExtension = 10.0;
    stopMotor();
    printReport();
    isTesting = false;
  }

  updateDisplay();
  delay(100);
}

bool debounceButton(int buttonPin) {
  static unsigned long lastPress[16] = {0};
  if (digitalRead(buttonPin) == LOW) {
    if (millis() - lastPress[buttonPin] > debounceDelay) {
      lastPress[buttonPin] = millis();
      while (digitalRead(buttonPin) == LOW);
      return true;
    }
  }
  return false;
}

void startTest() {
  isTesting = true;
  maxForce = 0;
  startTime = millis();
  digitalWrite(LED1, HIGH);
  moveClockwise();
  Serial.println("Test Started");
}

void moveClockwise() {
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  analogWrite(ENA, 255);
}

void moveCounterClockwise() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  analogWrite(ENA, 255);
}

void stopMotor() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  analogWrite(ENA, 0);
  digitalWrite(LED1, LOW);
  Serial.println("Motor Stopped");
}

void updateDisplay() {
  char buffer[10];
  u8g2.clearBuffer();
  u8g2.setCursor(0, 10);
  u8g2.print("Force: ");
  dtostrf(forceValue, 5, 2, buffer);
  u8g2.print(buffer);
  u8g2.print(" N");
  
  u8g2.setCursor(0, 25);
  u8g2.print("Max Force: ");
  dtostrf(maxForce, 5, 2, buffer);
  u8g2.print(buffer);
  u8g2.print(" N");
  
  u8g2.sendBuffer();
}

void printReport() {
  unsigned long elapsedTime = millis() - startTime;
  Serial.println("\nHHRCM-NCRA Lab");
  Serial.println("NED Medical Pull Tester");
  Serial.println("------------------------");
  Serial.print("Duration: "); Serial.print(elapsedTime / 1000.0); Serial.println(" s");
  Serial.print("Max Force: "); Serial.print(maxForce); Serial.println(" N");
  Serial.print("Break Extension: "); Serial.print(breakExtension); Serial.println(" cm");
  Serial.println("------------------------\n");
}
